#!/bin/bash
# =========================================================
# SOFE 3200 - Final Project: Task Scheduling and Workflows
# Author: Rabab Raza
# File: tswf.sh
# Description:
#   CLI tool to manage recurring tasks and simple workflows.
#   Supports task add, task rm, workflow run, and help menus.
# =========================================================

TASK_DB="$HOME/.tswf/tasks.db"
LOG_FILE="$HOME/.tswf/tswf.log"

# Ensure storage directory exists
mkdir -p "$(dirname "$TASK_DB")"

# ===========================
# Utility Functions
# ===========================

log_message() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" >> "$LOG_FILE"
}

show_help() {
    cat << EOF
Usage: ./tswf.sh [command] [subcommand] [arguments]

Available commands:
  task add <name> <frequency> <time> <command>
      - Add a new recurring task.
      - Example: ./tswf.sh task add "Backup" daily "02:30" "echo 'Running backup'"

  task rm <name>
      - Remove a task by name.

  workflow run <workflow_name>
      - Simulate running a workflow (series of tasks).

  help
      - Show this help menu.

Supported frequencies:
  daily, weekly, monthly
EOF
}

validate_time_format() {
    if [[ ! $1 =~ ^([01]?[0-9]|2[0-3]):[0-5][0-9]$ ]]; then
        echo "Error: Invalid time format. Use HH:MM (24-hour format)."
        exit 1
    fi
}

# ===========================
# Task Management
# ===========================

add_task() {
    local name="$1"
    local frequency="$2"
    local time="$3"
    local command="$4"

    [[ -z "$name" || -z "$frequency" || -z "$time" || -z "$command" ]] && {
        echo "Error: Missing arguments."
        echo "Usage: ./tswf.sh task add <name> <frequency> <time> <command>"
        exit 1
    }

    validate_time_format "$time"

    case "$frequency" in
        daily|weekly|monthly) ;;
        *) echo "Error: Invalid frequency. Use daily, weekly, or monthly."; exit 1 ;;
    esac

    # Save task
    local id
    id=$(date +%s%N | cut -b1-10)
    echo "$id|$name|$frequency|$time|$command" >> "$TASK_DB"
    log_message "Task added: $name ($frequency at $time)"

    echo "‚úÖ Task '$name' added successfully!"
}

remove_task() {
    local name="$1"
    [[ -z "$name" ]] && { echo "Error: Missing task name."; exit 1; }

    if grep -q "|$name|" "$TASK_DB"; then
        grep -v "|$name|" "$TASK_DB" > "$TASK_DB.tmp" && mv "$TASK_DB.tmp" "$TASK_DB"
        log_message "Task removed: $name"
        echo "üóëÔ∏è Task '$name' removed successfully."
    else
        echo "Error: Task '$name' not found."
    fi
}

# ===========================
# Workflow Management
# ===========================

run_workflow() {
    local workflow_name="$1"
    [[ -z "$workflow_name" ]] && { echo "Error: Missing workflow name."; exit 1; }

    echo "üöÄ Running workflow: $workflow_name"
    log_message "Workflow started: $workflow_name"

    while IFS='|' read -r id name freq time command; do
        echo "‚è±Ô∏è Executing task: $name ($freq at $time)"
        eval "$command"
        sleep 1
        log_message "Executed task: $name"
    done < "$TASK_DB"

    echo "‚úÖ Workflow '$workflow_name' completed!"
    log_message "Workflow completed: $workflow_name"
}

# ===========================
# Main CLI Parser
# ===========================

case "$1" in
    task)
        case "$2" in
            add) shift 2; add_task "$@" ;;
            rm) shift 2; remove_task "$@" ;;
            *) echo "Error: Unknown task subcommand. Use add or rm."; show_help; exit 1 ;;
        esac
        ;;
    workflow)
        case "$2" in
            run) shift 2; run_workflow "$@" ;;
            *) echo "Error: Unknown workflow subcommand. Use run."; show_help; exit 1 ;;
        esac
        ;;
    help|"")
        show_help
        ;;
    *)
        echo "Error: Unknown command '$1'."
        show_help
        exit 1
        ;;
esac
